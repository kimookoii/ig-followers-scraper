name: Update IG Followers

# Run every 30 minutes and manual trigger
on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

# Grant permissions so GITHUB_TOKEN can push to gh-pages
permissions:
  contents: write
  pages: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # expose PAT_DEPLOY secret as env so it can be referenced in "if" expressions
    env:
      PAT_DEPLOY: ${{ secrets.PAT_DEPLOY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Playwright browsers & OS deps
        run: |
          npx playwright install --with-deps

      - name: Create logs dir
        run: mkdir -p ./logs

      - name: Start server (background)
        run: |
          nohup node index.js > ./logs/server.log 2>&1 &
          echo $! > ./server.pid
          sleep 1
          echo "Server PID: $(cat ./server.pid)"

      - name: Wait for server to be ready (max ~60s)
        run: |
          for i in $(seq 1 12); do
            if curl -sS "http://localhost:3000/" >/dev/null 2>&1; then
              echo "Server ready"
              exit 0
            fi
            echo "Waiting for server... ($i/12)"
            sleep 5
          done
          echo "Server did not start within expected time. Dumping server.log:"
          tail -n 200 ./logs/server.log || true
          exit 1

      - name: Fetch Instagram data (with retries)
        env:
          USERNAME: ziconkn_
        run: |
          set -euo pipefail
          URL="http://localhost:3000/api/followers?username=${USERNAME}"
          OUT="data.json"

          n=0
          until [ $n -ge 4 ]
          do
            echo "curl attempt $((n+1))..."
            if curl -sS --fail "$URL" -o "$OUT"; then
              echo "Fetched data to $OUT"
              exit 0
            fi
            n=$((n+1))
            echo "Request failed, sleeping $((n*5))s..."
            sleep $((n*5))
          done

          echo "All attempts failed; show last 300 lines server log:"
          tail -n 300 ./logs/server.log || true
          exit 1

      - name: Prepare output folder
        run: |
          mkdir -p out
          if [ -f data.json ]; then
            mv data.json out/ziconkn_.json
          else
            echo "data.json not found" >&2
            exit 1
          fi

      - name: Add timestamp to JSON
        run: |
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          jq --arg date "$DATE" '. + { lastUpdate: $date }' out/ziconkn_.json > out/tmp.json
          mv out/tmp.json out/ziconkn_.json
          echo "Wrote out/ziconkn_.json with lastUpdate=$DATE"

      - name: Show git config & remote (debug)
        run: |
          git config --list
          git remote -v || true

      - name: Deploy to GitHub Pages (using GITHUB_TOKEN)
        id: deploy_primary
        uses: peaceiris/actions-gh-pages@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: out
          user_name: 'github-actions[bot]'
          user_email: '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Fallback deploy using PAT (if primary failed and PAT provided)
        if: ${{ failure() && env.PAT_DEPLOY != '' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ env.PAT_DEPLOY }}
          publish_branch: gh-pages
          publish_dir: out
          user_name: 'deploy-bot'
          user_email: 'deploy-bot@users.noreply.github.com'

      - name: Upload logs & output on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scrape-debug-artifacts
          path: |
            logs/server.log
            out/ziconkn_.json
            data.json

      - name: Stop server (cleanup)
        if: always()
        run: |
          if [ -f ./server.pid ]; then
            pid=$(cat ./server.pid) || true
            echo "Killing server pid: $pid"
            kill "$pid" || true
            rm -f ./server.pid
          else
            echo "server.pid not found"
          fi

      - name: Show last server log (always)
        if: always()
        run: |
          echo "---- server.log (tail -n 200) ----"
          tail -n 200 ./logs/server.log || true
